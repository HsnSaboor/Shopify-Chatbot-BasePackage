<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transparent Chatbot Embed - Test Page</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: white;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .test-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    
    .test-card {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 24px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .test-card h3 {
      margin: 0 0 15px 0;
      color: #fff;
      font-size: 1.2rem;
    }
    
    .test-card p {
      margin: 0 0 15px 0;
      opacity: 0.9;
      line-height: 1.5;
    }
    
    button {
      background: #007cba;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      margin: 5px;
    }
    
    button:hover {
      background: #005a87;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 124, 186, 0.3);
    }
    
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-success { background: #10b981; }
    .status-warning { background: #f59e0b; }
    .status-error { background: #ef4444; }
    
    .debug-panel {
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      overflow-x: auto;
    }
    
    .navigation-test {
      margin: 30px 0;
      text-align: center;
    }
    
    .navigation-test a {
      display: inline-block;
      margin: 5px;
      padding: 10px 15px;
      background: rgba(255,255,255,0.2);
      color: white;
      text-decoration: none;
      border-radius: 6px;
      transition: all 0.3s ease;
    }
    
    .navigation-test a:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-1px);
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 20px 10px;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      .test-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <h1>üîç Transparent Chatbot Embed Test</h1>
  
  <div class="test-grid">
    <!-- Transparency Test -->
    <div class="test-card">
      <h3><span id="transparency-status" class="status-indicator status-warning"></span>Transparency Test</h3>
      <p>Testing transparent iframe creation and CSS reset functionality.</p>
      <button onclick="testTransparency()">Test Transparency</button>
      <button onclick="inspectIframe()">Inspect Iframe</button>
    </div>
    
    <!-- State Persistence Test -->
    <div class="test-card">
      <h3><span id="state-status" class="status-indicator status-warning"></span>State Persistence</h3>
      <p>Testing LocalStorage state management across navigation.</p>
      <button onclick="testStatePersistence()">Test State</button>
      <button onclick="clearState()">Clear State</button>
    </div>
    
    <!-- Data Extraction Test -->
    <div class="test-card">
      <h3><span id="data-status" class="status-indicator status-warning"></span>Data Extraction</h3>
      <p>Testing minimal Shopify data extraction and validation.</p>
      <button onclick="testDataExtraction()">Test Data</button>
      <button onclick="updateShopifyData()">Update Data</button>
    </div>
    
    <!-- Cart Integration Test -->
    <div class="test-card">
      <h3><span id="cart-status" class="status-indicator status-warning"></span>Cart Integration</h3>
      <p>Testing cart API integration and success popup display.</p>
      <button onclick="testCartIntegration()">Test Cart</button>
      <button onclick="testVariantSelection()">Test 2XL Variants</button>
    </div>
    
    <!-- Mobile Responsiveness Test -->
    <div class="test-card">
      <h3><span id="mobile-status" class="status-indicator status-warning"></span>Mobile Test</h3>
      <p>Testing 100vh mobile coverage and responsive design.</p>
      <button onclick="testMobileMode()">Test Mobile</button>
      <button onclick="testDesktopMode()">Test Desktop</button>
    </div>
    
    <!-- Performance Test -->
    <div class="test-card">
      <h3><span id="performance-status" class="status-indicator status-warning"></span>Performance</h3>
      <p>Testing script load time and bundle size impact.</p>
      <button onclick="testPerformance()">Run Benchmark</button>
      <button onclick="analyzeBundle()">Analyze Bundle</button>
    </div>
  </div>
  
  <!-- Debug Panel -->
  <div class="debug-panel" id="debug-output">
    <strong>Debug Output:</strong><br>
    Ready for testing... Enable debug mode for detailed logs.
  </div>
  
  <!-- Navigation Test -->
  <div class="navigation-test">
    <h3>üîÑ Navigation State Persistence Test</h3>
    <p>Test state persistence across page navigation:</p>
    <a href="#page1" onclick="simulateNavigation('page1')">Page 1</a>
    <a href="#page2" onclick="simulateNavigation('page2')">Page 2</a>
    <a href="#page3" onclick="simulateNavigation('page3')">Page 3</a>
    <button onclick="refreshPage()">Refresh Page</button>
  </div>
</div>

<!-- Transparent Chatbot Configuration -->
<script>
// Mock Shopify data for testing
window.CHATBOT_API_URL = "http://localhost:3000";
window.SHOPIFY_MINIMAL_DATA = {
  customerId: "test_customer_123",
  localization: "en",
  cartCurrency: "USD",
  pageType: "product",
  pageHandle: "test-product",
  shopDomain: "test-store.myshopify.com",
  currentPage: {
    url: window.location.href,
    title: "Test Product Page",
    handle: "test-product"
  },
  customer: {
    id: "test_customer_123",
    email: "test@example.com",
    firstName: "Test",
    lastName: "User"
  },
  product: {
    id: "test_product_456",
    handle: "test-product",
    title: "Test Product with 2XL",
    price: 2999,
    compareAtPrice: 3999,
    available: true,
    variants: [
      {
        id: "var_1",
        title: "Small / Red",
        option1: "S",
        option2: "Red",
        price: 2999,
        available: true
      },
      {
        id: "var_2", 
        title: "Medium / Red",
        option1: "M",
        option2: "Red",
        price: 2999,
        available: true
      },
      {
        id: "var_3",
        title: "Large / Red", 
        option1: "L",
        option2: "Red",
        price: 2999,
        available: true
      },
      {
        id: "var_4",
        title: "2XL / Red",
        option1: "2XL",
        option2: "Red", 
        price: 3299,
        available: true
      },
      {
        id: "var_5",
        title: "Small / Blue",
        option1: "S",
        option2: "Blue",
        price: 2999,
        available: true
      }
    ]
  },
  cart: {
    itemCount: 2,
    totalPrice: 5998,
    currency: "USD"
  }
};

// Enable debug mode
window.TRANSPARENT_CHATBOT_CONFIG = {
  debug: true
};

// Test Functions
function log(message, type = 'info') {
  const output = document.getElementById('debug-output');
  const timestamp = new Date().toLocaleTimeString();
  const color = type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#3b82f6';
  output.innerHTML += `<br><span style="color: ${color}">[${timestamp}] ${message}</span>`;
  output.scrollTop = output.scrollHeight;
  console.log(`[Transparent Chatbot Test] ${message}`);
}

function updateStatus(testId, status) {
  const indicator = document.getElementById(`${testId}-status`);
  indicator.className = `status-indicator status-${status}`;
}

function testTransparency() {
  log('Testing transparency...', 'info');
  
  try {
    const container = document.getElementById('transparent-chatbot-container');
    const iframe = document.getElementById('transparent-chatbot-iframe');
    
    if (!container || !iframe) {
      log('Transparent chatbot not found - ensure script is loaded', 'error');
      updateStatus('transparency', 'error');
      return;
    }
    
    // Check transparency properties
    const containerStyles = window.getComputedStyle(container);
    const iframeStyles = window.getComputedStyle(iframe);
    
    const tests = [
      { name: 'Container Position', value: containerStyles.position, expected: 'fixed' },
      { name: 'Container Z-Index', value: containerStyles.zIndex, expected: '9999' },
      { name: 'Container Pointer Events', value: containerStyles.pointerEvents, expected: 'none' },
      { name: 'Iframe Background', value: iframeStyles.background, expected: 'transparent' },
      { name: 'Container Width', value: containerStyles.width, expected: '100%' },
      { name: 'Container Height', value: containerStyles.height, expected: '100%' }
    ];
    
    let passed = 0;
    tests.forEach(test => {
      const success = test.value.includes(test.expected) || test.value === test.expected;
      log(`${test.name}: ${test.value} ${success ? '‚úÖ' : '‚ùå'}`, success ? 'success' : 'error');
      if (success) passed++;
    });
    
    updateStatus('transparency', passed === tests.length ? 'success' : 'warning');
    log(`Transparency test: ${passed}/${tests.length} passed`, passed === tests.length ? 'success' : 'warning');
    
  } catch (error) {
    log(`Transparency test error: ${error.message}`, 'error');
    updateStatus('transparency', 'error');
  }
}

function inspectIframe() {
  const iframe = document.getElementById('transparent-chatbot-iframe');
  if (iframe) {
    log(`Iframe src: ${iframe.src}`, 'info');
    log(`Iframe dimensions: ${iframe.offsetWidth}x${iframe.offsetHeight}`, 'info');
    log(`Iframe position: ${iframe.style.position}`, 'info');
  } else {
    log('Iframe not found', 'error');
  }
}

function testStatePersistence() {
  log('Testing state persistence...', 'info');
  
  try {
    const testState = {
      isOpen: true,
      messageCount: 5,
      currentPage: window.location.href,
      testTimestamp: Date.now()
    };
    
    // Save test state
    localStorage.setItem('shopify_chatbot_state', JSON.stringify(testState));
    log('Test state saved to localStorage', 'success');
    
    // Retrieve and validate
    const retrieved = JSON.parse(localStorage.getItem('shopify_chatbot_state'));
    const matches = retrieved.testTimestamp === testState.testTimestamp;
    
    log(`State retrieval: ${matches ? 'SUCCESS' : 'FAILED'}`, matches ? 'success' : 'error');
    log(`Retrieved state: ${JSON.stringify(retrieved, null, 2)}`, 'info');
    
    updateStatus('state', matches ? 'success' : 'error');
    
  } catch (error) {
    log(`State persistence test error: ${error.message}`, 'error');
    updateStatus('state', 'error');
  }
}

function clearState() {
  localStorage.removeItem('shopify_chatbot_state');
  log('Chatbot state cleared', 'info');
}

function testDataExtraction() {
  log('Testing data extraction...', 'info');
  
  try {
    const data = window.SHOPIFY_MINIMAL_DATA;
    
    if (!data) {
      log('SHOPIFY_MINIMAL_DATA not found', 'error');
      updateStatus('data', 'error');
      return;
    }
    
    const requiredFields = ['customerId', 'localization', 'cartCurrency', 'shopDomain'];
    let validFields = 0;
    
    requiredFields.forEach(field => {
      const exists = data[field] !== undefined && data[field] !== null;
      log(`${field}: ${data[field]} ${exists ? '‚úÖ' : '‚ùå'}`, exists ? 'success' : 'error');
      if (exists) validFields++;
    });
    
    // Test product variants (including 2XL)
    if (data.product && data.product.variants) {
      const sizes = data.product.variants.map(v => v.option1).filter(Boolean);
      const has2XL = sizes.includes('2XL');
      log(`Available sizes: ${sizes.join(', ')}`, 'info');
      log(`2XL support: ${has2XL ? 'YES' : 'NO'} ${has2XL ? '‚úÖ' : '‚ùå'}`, has2XL ? 'success' : 'warning');
    }
    
    updateStatus('data', validFields === requiredFields.length ? 'success' : 'warning');
    log(`Data extraction: ${validFields}/${requiredFields.length} required fields present`, 'info');
    
  } catch (error) {
    log(`Data extraction test error: ${error.message}`, 'error');
    updateStatus('data', 'error');
  }
}

function updateShopifyData() {
  if (window.transparentChatbotManager) {
    window.transparentChatbotManager.updateShopifyData();
    log('Shopify data updated via API', 'success');
  } else {
    log('Transparent chatbot manager not available', 'error');
  }
}

function testCartIntegration() {
  log('Testing cart integration...', 'info');
  
  // Mock cart operation
  const mockCartData = {
    items: [{
      id: 'var_4',
      product_title: 'Test Product with 2XL',
      variant_title: '2XL / Red',
      price: 3299,
      quantity: 1
    }],
    total_price: 3299,
    item_count: 1
  };
  
  try {
    // Test if CartSuccessPopup can be displayed
    if (typeof window !== 'undefined') {
      log('Simulating cart success popup...', 'info');
      
      // Create a simple test popup
      const popup = document.createElement('div');
      popup.id = 'test-cart-popup';
      popup.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        color: black;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10001;
        text-align: center;
      `;
      popup.innerHTML = `
        <h3>‚úÖ Added to Cart!</h3>
        <p>Test Product with 2XL - $32.99</p>
        <button onclick="document.body.removeChild(this.parentNode)">Close</button>
      `;
      
      document.body.appendChild(popup);
      
      // Auto-remove after 3 seconds
      setTimeout(() => {
        if (document.getElementById('test-cart-popup')) {
          document.body.removeChild(popup);
        }
      }, 3000);
      
      log('Cart popup displayed successfully', 'success');
      updateStatus('cart', 'success');
    }
    
  } catch (error) {
    log(`Cart integration test error: ${error.message}`, 'error');
    updateStatus('cart', 'error');
  }
}

function testVariantSelection() {
  log('Testing 2XL variant selection...', 'info');
  
  const product = window.SHOPIFY_MINIMAL_DATA?.product;
  if (!product) {
    log('No product data available for testing', 'error');
    return;
  }
  
  const sizes = product.variants.map(v => v.option1).filter(Boolean);
  const colors = [...new Set(product.variants.map(v => v.option2).filter(Boolean))];
  
  log(`Available sizes: ${sizes.join(', ')}`, 'info');
  log(`Available colors: ${colors.join(', ')}`, 'info');
  
  const has2XL = sizes.includes('2XL');
  log(`2XL variant support: ${has2XL ? 'SUPPORTED' : 'NOT FOUND'}`, has2XL ? 'success' : 'warning');
  
  if (has2XL) {
    const xl2Variants = product.variants.filter(v => v.option1 === '2XL');
    log(`2XL variants found: ${xl2Variants.length}`, 'info');
    xl2Variants.forEach(variant => {
      log(`  - ${variant.title} (${variant.available ? 'Available' : 'Out of stock'})`, 'info');
    });
  }
}

function testMobileMode() {
  log('Testing mobile mode...', 'info');
  
  // Simulate mobile viewport
  const viewport = document.querySelector('meta[name="viewport"]');
  if (viewport) {
    log(`Current viewport: ${viewport.content}`, 'info');
  }
  
  // Check if container adapts to mobile
  const container = document.getElementById('transparent-chatbot-container');
  if (container) {
    const isMobile = window.innerWidth < 768;
    log(`Current screen width: ${window.innerWidth}px (${isMobile ? 'Mobile' : 'Desktop'})`, 'info');
    log(`Container should use: ${isMobile ? '100vw √ó 100vh' : '500px √ó 600px'}`, 'info');
    updateStatus('mobile', 'success');
  } else {
    log('Chatbot container not found', 'error');
    updateStatus('mobile', 'error');
  }
}

function testDesktopMode() {
  log('Testing desktop mode...', 'info');
  testMobileMode(); // Same logic, different context
}

function testPerformance() {
  log('Running performance benchmark...', 'info');
  
  const startTime = performance.now();
  
  // Test script size
  const scripts = document.querySelectorAll('script[src*="transparent-chatbot-embed"]');
  if (scripts.length > 0) {
    log(`Transparent embed script found: ${scripts[0].src}`, 'success');
  }
  
  // Test initialization time
  const initTime = performance.now() - startTime;
  log(`Initialization time: ${initTime.toFixed(2)}ms`, initTime < 100 ? 'success' : 'warning');
  
  // Test memory usage (approximate)
  if (performance.memory) {
    const memoryMB = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(2);
    log(`Memory usage: ${memoryMB}MB`, 'info');
  }
  
  updateStatus('performance', initTime < 100 ? 'success' : 'warning');
}

function analyzeBundle() {
  log('Analyzing bundle size...', 'info');
  
  // Estimate script size
  fetch('./transparent-chatbot-embed.js')
    .then(response => response.blob())
    .then(blob => {
      const sizeKB = (blob.size / 1024).toFixed(2);
      log(`Bundle size: ${sizeKB}KB`, sizeKB < 10 ? 'success' : 'warning');
      log(`Target: <5KB production, <2KB gzipped`, 'info');
    })
    .catch(error => {
      log(`Bundle analysis failed: ${error.message}`, 'error');
    });
}

function simulateNavigation(page) {
  log(`Simulating navigation to ${page}...`, 'info');
  
  // Save state before navigation
  const currentState = {
    page: page,
    timestamp: Date.now(),
    isOpen: true
  };
  
  localStorage.setItem('shopify_chatbot_state', JSON.stringify(currentState));
  
  // Simulate page change
  setTimeout(() => {
    const saved = localStorage.getItem('shopify_chatbot_state');
    const parsed = JSON.parse(saved);
    log(`Navigation to ${page} complete. State preserved: ${parsed.page === page ? 'YES' : 'NO'}`, 'success');
  }, 100);
}

function refreshPage() {
  log('Refreshing page to test state persistence...', 'info');
  setTimeout(() => {
    window.location.reload();
  }, 1000);
}

// Auto-run basic tests on load
window.addEventListener('load', () => {
  log('Test page loaded', 'success');
  log('Waiting for transparent chatbot to initialize...', 'info');
  
  // Wait for chatbot to initialize
  setTimeout(() => {
    if (document.getElementById('transparent-chatbot-container')) {
      log('Transparent chatbot detected!', 'success');
      testDataExtraction();
    } else {
      log('Transparent chatbot not found. Make sure the script is loaded.', 'warning');
    }
  }, 2000);
});

// Listen for chatbot events
window.addEventListener('message', (event) => {
  log(`Received message: ${event.data.type}`, 'info');
});

</script>

<!-- Load the transparent chatbot embed script -->
<script src="./transparent-chatbot-embed.js" async></script>

</body>
</html>